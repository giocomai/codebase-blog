---
title: "Animating 'One Degree Warmer' time series with ggplot2 and gganimate"
author: 'Giorgio Comai'
date: '2018-10-12'
slug: one-degree-warmer-animating-time-series-with-ggplot-and-gganimate
categories: [rstats]
tags: []
---



<p>[<strong>Notice: this is still a draft</strong>]</p>
<pre class="r"><code>if(!require(&quot;pacman&quot;)) install.packages(&quot;pacman&quot;)

knitr::opts_chunk$set(echo = TRUE)

# pacman::p_load(&quot;googlesheets&quot;) # to get the data from google docs
pacman::p_load(&quot;readxl&quot;) # to read xlsx file
pacman::p_load(&quot;ggrepel&quot;) # used for labeling
  
if (!require(&quot;gganimate&quot;)) devtools::install_github(&quot;thomasp85/gganimate&quot;)
library(&quot;gganimate&quot;) # get moving!


pacman::p_load(&quot;tidyverse&quot;) # all the goodies!

# If you want to change font
# pacman::p_load(&quot;extrafont&quot;)
# extrafont::loadfonts()</code></pre>
<div id="get-and-clean-the-data" class="section level1">
<h1>Get and clean the data</h1>
<pre class="r"><code># indicators
# https://docs.google.com/spreadsheets/d/1X5J3GbAKGL5DxwB0aUzAutslHgZ7XFazkVmfQyXhIqM/edit#gid=595233479

# Temperature per year and location
#https://docs.google.com/spreadsheets/d/1avuUJmVNljyb2uotHKDGgrG8T74O7CcwG15p0budkH8/edit?usp=sharing

dir.create(path = 
             file.path(&quot;..&quot;,
                       &quot;..&quot;,
                       &quot;static&quot;,
                       &quot;onedegreewarmer&quot;),
           showWarnings = FALSE)

temperatures_xlsx_location &lt;-
  file.path(&quot;..&quot;, &quot;..&quot;, &quot;static&quot;,
            &quot;onedegreewarmer&quot;,
            &quot;temperatures.xlsx&quot;)

temperaturesMerged_csv_location  &lt;-
  file.path(&quot;..&quot;, &quot;..&quot;,
            &quot;static&quot;,
            &quot;onedegreewarmer&quot;,
            &quot;temperaturesMerged.csv&quot;)

if (!file.exists(temperaturesMerged_csv_location)) {
  #gets each sheet of the excel file, and reads it separately
  temperaturesL &lt;- lapply(excel_sheets(temperatures_xlsx_location),
                          read_excel,
                          path = temperatures_xlsx_location)
  names(temperaturesL) &lt;- excel_sheets(temperatures_xlsx_location)
  temperatures &lt;- purrr::map_df(.x = temperaturesL,
                                .f = bind_cols,
                                .id = &quot;City&quot;) %&gt;% 
    select(-2)

  write_csv(x = temperatures,
            path = temperaturesMerged_csv_location)
} else {
  temperatures &lt;- read_csv(temperaturesMerged_csv_location)
}</code></pre>
<pre class="r"><code>indicators &lt;- read_csv(file = file.path(&quot;..&quot;,
                                        &quot;..&quot;,
                                        &quot;static&quot;,
                                        &quot;onedegreewarmer&quot;,
                                        &quot;indicators.csv&quot;))

tempCoord &lt;- left_join(x = temperatures,
                       y = indicators %&gt;%
                         select(City = city, lat, lon, size),
                       by = &quot;City&quot;)</code></pre>
<pre class="r"><code>i &lt;- &quot;Granada&quot;

oneCity &lt;- 
  temperatures %&gt;% 
  filter(City == i) %&gt;% 
  mutate(century = str_extract(string = date,
                               pattern = &quot;[[:digit:]][[:digit:]]&quot;)) %&gt;% 
  group_by(century) %&gt;% 
  mutate(AverageTempCentury = mean(temperature)) %&gt;% 
  mutate(date = lubridate::year(date)) %&gt;% 
  rename(Date = date)

oneCity &lt;-  oneCity %&gt;% 
  mutate(TempDifference = max(oneCity$AverageTempCentury)-min(oneCity$AverageTempCentury)) 


staticOneCity &lt;- 
  ggplot(data = oneCity,
         mapping = aes(x = Date,
                       y = temperature,
                       colour = `temperature`,
                       AverageTempCentury)) +
  geom_line(size = 1, color = &quot;gray&quot;) +
  geom_point() +

  # 21st century horizontal line
  geom_segment(aes(x = 1900,
                   y = unique(oneCity$AverageTempCentury)[1],
                   xend = 2000,
                   yend = unique(oneCity$AverageTempCentury)[1]),
               colour = &quot;#6f2c91&quot;,
               linetype=2) +
  geom_segment(aes(x = 2000,
                   y = unique(oneCity$AverageTempCentury)[1],
                   xend = 2017,
                   yend = unique(oneCity$AverageTempCentury)[1]),
               colour = &quot;#a6ce39&quot;,
               linetype=1) +
  # 20th century horizontal line
  geom_segment(aes(x = 1900,
                   y = unique(oneCity$AverageTempCentury)[2],
                   xend = 2000,
                   yend = unique(oneCity$AverageTempCentury)[2]),
               colour = &quot;#a6ce39&quot;) +
  geom_segment(aes(x = 2000,
                   y = unique(oneCity$AverageTempCentury)[2],
                   xend = 2017,
                   yend = unique(oneCity$AverageTempCentury)[2]),
               colour = &quot;#6f2c91&quot;,
               linetype=2) +
  # define colour of points
  scale_color_viridis_c(option = &quot;magma&quot;,
                        direction = -1,
                        guide = FALSE) + 
  # define breaks and labeling on scales
  scale_x_continuous(name = &quot;&quot;,
                     breaks = c(1900, 1925, 1950, 1975, 2000, 2017)) +
  scale_y_continuous(name = &quot;&quot;,
                     labels = function(x) scales::number(x = x, suffix = &quot;°&quot;)) +
  # basic styling and font
  theme_minimal(base_family = &quot;Carlito&quot;,
                base_size = 16)+
  # labels for horizontal lines
  annotate(geom = &quot;text&quot;,
           x = 1915,
           y = unique(oneCity$AverageTempCentury),
           label = c(&quot;19th century average&quot;,
                     &quot;20th century average&quot;),
           vjust = -1,
           fontface = 2,
           size = 4) +
  labs(title = paste(&quot;Average temperature in&quot;, i, &quot;(1900-2017)&quot;), 
       caption = &quot;Source: EdjNet/ECMWF&quot;) +
  theme(plot.caption=element_text(hjust = 0,
                                  colour = &quot;darkgray&quot;)) +
    coord_cartesian(clip = &#39;off&#39;) +
# label final temperatures 
  geom_label_repel(data = oneCity %&gt;%
                     distinct(century, .keep_all = TRUE) %&gt;%
                     select(-Date),
                   mapping = aes(x = 2000,
                                 y = AverageTempCentury,
                                 label = scales::number(AverageTempCentury,
                                                        accuracy = 0.01,
                                                        suffix = &quot;°&quot;)),
                   nudge_x = c(3, -3),
                   nudge_y = c(-1,3),
                   segment.size  = 0.2,
                   colour = &quot;black&quot;) +
  # draw curved line
  geom_curve(aes(x = 2000,
                 y = unique(oneCity$AverageTempCentury)[1],
                 xend = 2017,
                 yend = unique(oneCity$AverageTempCentury)[2]),
             colour = &quot;#6f2c91&quot;,
             linetype=1,
             curvature = 0.6,
             arrow =  arrow(length = unit(0.15, &quot;inches&quot;))) +
   geom_label(data = oneCity %&gt;%
                distinct(TempDifference, .keep_all = TRUE),
              mapping = aes(x = 2020,
                            y = mean(AverageTempCentury),
                            label = scales::number(TempDifference,
                                                   accuracy = 0.01,
                                                   suffix = &quot;°&quot;)), colour = &quot;black&quot;)
    
staticOneCity</code></pre>
<p><img src="/post/2018-10-12-one-degree-warmer-animating-time-series-with-ggplot-and-gganimate_files/figure-html/staticOneCity-1.png" width="672" /></p>
<div id="animate-the-graph" class="section level2">
<h2>Animate the graph</h2>
<p>Thanks to the excellent work done by <a href="https://twitter.com/thomasp85/">Thomas Lin Pedersen</a> on <code>gganimate</code>, it’s now a single line of code to add animation to the above graph.</p>
<pre class="r"><code>animatedOneCity &lt;- staticOneCity +
  transition_reveal(id = City, along = Date)</code></pre>
<p>And here it is as a GIF:</p>
<pre class="r"><code>animate(plot = animatedOneCity +
  transition_reveal(id = City, along = Date),
 width = 800, height = 600, res = 120)</code></pre>
<p><img src="/post/2018-10-12-one-degree-warmer-animating-time-series-with-ggplot-and-gganimate_files/figure-html/animatedOneCity-1.gif" /><!-- --></p>
</div>
</div>
<div id="export-as-high-quality-video" class="section level1">
<h1>Export as high quality video</h1>
<p>Thanks to the latest <code>av</code> packge by rOpenSci, it’s now easy to export the graph in high quality video formats (<a href="https://ropensci.org/technotes/2018/10/06/av-release/">see the blog bost announcing the release of the package</a>).</p>
<pre class="r"><code>pacman::p_load(&quot;av&quot;) # for video rendering

# Render and show the video
mp4 &lt;- animate(animatedOneCity, renderer = av_renderer(&#39;animation.mp4&#39;),
    width = 1920, height = 1080, res = 200, fps = 25)
utils::browseURL(&#39;animation.mp4&#39;)</code></pre>
</div>
<div id="bulk-create-graphs" class="section level1">
<h1>Bulk create graphs</h1>
<p>[link to repository with script coming soon]</p>
</div>
